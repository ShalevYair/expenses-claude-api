<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ניהול מאגר נתונים - מנתח ההוצאות 🔧📊</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Papa Parse for CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #f8fafc 0%, #e0f2fe 50%, #e0e7ff 100%);
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .table-row:hover {
            background-color: #f8fafc;
        }
        
        .border-dashed-3 {
            border-width: 3px;
            border-style: dashed;
        }
        
        .text-gradient {
            background: linear-gradient(to right, #7c3aed, #2563eb);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .pulse-success {
            animation: pulse-success 2s ease-in-out;
        }
        
        @keyframes pulse-success {
            0%, 100% { background-color: transparent; }
            50% { background-color: rgba(34, 197, 94, 0.1); }
        }

        .tab-button {
            transition: all 0.3s ease;
        }

        .tab-button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .editable-cell {
            transition: all 0.2s ease;
            cursor: pointer;
            padding: 8px;
            border-radius: 4px;
        }

        .editable-cell:hover {
            background-color: #f3f4f6;
        }

        .editing {
            background-color: #dbeafe !important;
            border: 2px solid #3b82f6;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <!-- מסך זיהוי -->
    <div class="fixed inset-0 bg-gradient-to-br from-blue-600 to-purple-700 flex items-center justify-center z-50" id="authScreen">
        <div class="glass-card rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4">
            <div class="text-center">
                <div class="text-6xl mb-6">🔐</div>
                <h1 class="text-2xl font-bold text-slate-800 mb-4">
                    גישת מנהל נדרשת
                </h1>
                <p class="text-slate-600 mb-6">
                    דף זה מיועד למנהלי המערכת בלבד לניהול מאגר הנתונים
                </p>
                <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                    <div class="flex items-center gap-2 text-red-800 text-sm">
                        <span class="text-lg">⚠️</span>
                        <span>גישה מוגבלת למנהלים מורשים בלבד</span>
                    </div>
                </div>
                <button onclick="redirectToAuth()" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-3 px-6 rounded-lg font-semibold hover:from-blue-700 hover:to-purple-700 transition-all duration-200 shadow-lg">
                    התחבר כמנהל
                </button>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto p-4" id="app" style="display: none;">
        
        <!-- כותרת ראשית -->
        <div class="glass-card rounded-2xl shadow-xl p-8 mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-4xl font-bold text-gradient mb-3">
                        🔧 ניהול מאגר נתונים
                    </h1>
                    <p class="text-slate-600 text-lg">
                        ניהול מילון חכם ומאגר עסקים למנתח ההוצאות
                    </p>
                </div>
                
                <div class="flex items-center gap-4">
                    <div class="text-right">
                        <div class="text-sm text-slate-600">מנהל:</div>
                        <div class="font-semibold text-slate-800" id="adminEmail">טוען...</div>
                    </div>
                    <img id="adminPhoto" class="w-10 h-10 rounded-full border-2 border-slate-300" alt="תמונת פרופיל">
                    <button onclick="signOut()" class="px-4 py-2 bg-red-600 text-white rounded-lg text-sm hover:bg-red-700 transition-colors">
                        יציאה
                    </button>
                </div>
            </div>

            <!-- סטטיסטיקות מהירות -->
            <div class="mt-6 grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 text-center">
                    <div class="text-2xl font-bold text-blue-800" id="keywordsCount">0</div>
                    <div class="text-sm text-blue-600">מילות מפתח</div>
                </div>
                <div class="bg-green-50 border border-green-200 rounded-xl p-4 text-center">
                    <div class="text-2xl font-bold text-green-800" id="businessesCount">0</div>
                    <div class="text-sm text-green-600">עסקים</div>
                </div>
                <div class="bg-purple-50 border border-purple-200 rounded-xl p-4 text-center">
                    <div class="text-2xl font-bold text-purple-800" id="usersCount">0</div>
                    <div class="text-sm text-purple-600">משתמשים</div>
                </div>
                <div class="bg-orange-50 border border-orange-200 rounded-xl p-4 text-center">
                    <div class="text-2xl font-bold text-orange-800" id="analysisCount">0</div>
                    <div class="text-sm text-orange-600">ניתוחים</div>
                </div>
            </div>
        </div>

        <!-- טאבים -->
        <div class="glass-card rounded-2xl shadow-xl mb-8">
            <div class="flex border-b border-slate-200">
                <button onclick="switchTab('keywords')" class="tab-button px-6 py-4 font-semibold rounded-tl-2xl active" id="tab-keywords">
                    📝 מילון חכם
                </button>
                <button onclick="switchTab('businesses')" class="tab-button px-6 py-4 font-semibold" id="tab-businesses">
                    🏪 מאגר עסקים
                </button>
                <button onclick="switchTab('users')" class="tab-button px-6 py-4 font-semibold" id="tab-users">
                    👥 משתמשים
                </button>
                <button onclick="switchTab('analysis')" class="tab-button px-6 py-4 font-semibold rounded-tr-2xl" id="tab-analysis">
                    📊 ניתוחים
                </button>
            </div>

            <!-- תוכן טאב מילון חכם -->
            <div id="content-keywords" class="p-8">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-slate-800 mb-4">📝 ניהול מילון חכם</h2>
                    <p class="text-slate-600 mb-6">
                        מילות מפתח לסיווג אוטומטי של עסקאות. כל מילת מפתח מקושרת לקטגוריה.
                    </p>

                    <!-- העלאת קובץ CSV -->
                    <div class="mb-6">
                        <label class="cursor-pointer">
                            <div class="border-dashed-3 border-blue-400 bg-blue-50 rounded-xl p-6 hover:border-blue-500 hover:bg-blue-100 transition-all duration-300">
                                <div class="text-center">
                                    <div class="text-3xl text-blue-600 mb-2">📁</div>
                                    <span class="text-lg font-semibold text-blue-800 block mb-1">טען קובץ CSV - מילון חכם</span>
                                    <span class="text-sm text-blue-600">עמודות נדרשות: מילת מפתח, קטגוריה</span>
                                </div>
                            </div>
                            <input type="file" accept=".csv" class="hidden" onchange="handleKeywordsUpload(event)">
                        </label>
                    </div>

                    <!-- הוספה ידנית -->
                    <div class="bg-slate-50 rounded-xl p-6 mb-6">
                        <h3 class="text-lg font-semibold text-slate-800 mb-4">הוסף מילת מפתח חדשה</h3>
                        <div class="flex gap-4">
                            <input type="text" id="newKeyword" placeholder="מילת מפתח" 
                                   class="flex-1 border border-slate-300 rounded-lg px-4 py-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                            <select id="newKeywordCategory" class="border border-slate-300 rounded-lg px-4 py-2 focus:border-blue-500">
                                <option value="">בחר קטגוריה</option>
                                <option value="מזון">מזון</option>
                                <option value="רכב">רכב</option>
                                <option value="בריאות">בריאות</option>
                                <option value="ביטוח">ביטוח</option>
                                <option value="חשבונות">חשבונות</option>
                                <option value="חינוך">חינוך</option>
                                <option value="דיור">דיור</option>
                                <option value="החזר חוב">החזר חוב</option>
                                <option value="קניות לבית">קניות לבית</option>
                                <option value="השקעות">השקעות</option>
                                <option value="פנאי">פנאי</option>
                                <option value="אחר">אחר</option>
                            </select>
                            <button onclick="addKeyword()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors">
                                הוסף
                            </button>
                        </div>
                    </div>
                </div>

                <!-- טבלת מילות מפתח -->
                <div class="overflow-x-auto rounded-xl border border-slate-200 shadow-sm">
                    <table class="w-full table-auto bg-white">
                        <thead>
                            <tr class="bg-gradient-to-r from-slate-100 to-slate-50 border-b border-slate-200">
                                <th class="text-right p-4 font-bold text-slate-700">מילת מפתח</th>
                                <th class="text-right p-4 font-bold text-slate-700">קטגוריה</th>
                                <th class="text-center p-4 font-bold text-slate-700 w-32">פעולות</th>
                            </tr>
                        </thead>
                        <tbody id="keywordsTableBody">
                            <tr>
                                <td colspan="3" class="p-8 text-center text-slate-500">
                                    טוען נתונים...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="mt-6 text-center">
                    <button onclick="saveKeywordsToFirebase()" class="bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 transition-colors font-semibold shadow-lg">
                        💾 שמור שינויים ל-Firebase
                    </button>
                </div>
            </div>

            <!-- תוכן טאב מאגר עסקים -->
            <div id="content-businesses" class="p-8 hidden">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-slate-800 mb-4">🏪 ניהול מאגר עסקים</h2>
                    <p class="text-slate-600 mb-6">
                        מאגר עסקים מסווגים לזיהוי מהיר של עסקאות. כל עסק מקושר לקטגוריה ספציפית.
                    </p>

                    <!-- העלאת קובץ CSV -->
                    <div class="mb-6">
                        <label class="cursor-pointer">
                            <div class="border-dashed-3 border-green-400 bg-green-50 rounded-xl p-6 hover:border-green-500 hover:bg-green-100 transition-all duration-300">
                                <div class="text-center">
                                    <div class="text-3xl text-green-600 mb-2">📁</div>
                                    <span class="text-lg font-semibold text-green-800 block mb-1">טען קובץ CSV - מאגר עסקים</span>
                                    <span class="text-sm text-green-600">עמודות נדרשות: שם עסק, קטגוריה</span>
                                </div>
                            </div>
                            <input type="file" accept=".csv" class="hidden" onchange="handleBusinessesUpload(event)">
                        </label>
                    </div>

                    <!-- הוספה ידנית -->
                    <div class="bg-slate-50 rounded-xl p-6 mb-6">
                        <h3 class="text-lg font-semibold text-slate-800 mb-4">הוסף עסק חדש</h3>
                        <div class="flex gap-4">
                            <input type="text" id="newBusiness" placeholder="שם העסק" 
                                   class="flex-1 border border-slate-300 rounded-lg px-4 py-2 focus:border-green-500 focus:ring-2 focus:ring-green-200">
                            <select id="newBusinessCategory" class="border border-slate-300 rounded-lg px-4 py-2 focus:border-green-500">
                                <option value="">בחר קטגוריה</option>
                                <option value="מזון">מזון</option>
                                <option value="רכב">רכב</option>
                                <option value="בריאות">בריאות</option>
                                <option value="ביטוח">ביטוח</option>
                                <option value="חשבונות">חשבונות</option>
                                <option value="חינוך">חינוך</option>
                                <option value="דיור">דיור</option>
                                <option value="החזר חוב">החזר חוב</option>
                                <option value="קניות לבית">קניות לבית</option>
                                <option value="השקעות">השקעות</option>
                                <option value="פנאי">פנאי</option>
                                <option value="אחר">אחר</option>
                            </select>
                            <button onclick="addBusiness()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors">
                                הוסף
                            </button>
                        </div>
                    </div>
                </div>

                <!-- טבלת עסקים -->
                <div class="overflow-x-auto rounded-xl border border-slate-200 shadow-sm">
                    <table class="w-full table-auto bg-white">
                        <thead>
                            <tr class="bg-gradient-to-r from-slate-100 to-slate-50 border-b border-slate-200">
                                <th class="text-right p-4 font-bold text-slate-700">שם העסק</th>
                                <th class="text-right p-4 font-bold text-slate-700">קטגוריה</th>
                                <th class="text-center p-4 font-bold text-slate-700 w-32">פעולות</th>
                            </tr>
                        </thead>
                        <tbody id="businessesTableBody">
                            <tr>
                                <td colspan="3" class="p-8 text-center text-slate-500">
                                    טוען נתונים...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="mt-6 text-center">
                    <button onclick="saveBusinessesToFirebase()" class="bg-green-600 text-white px-8 py-3 rounded-lg hover:bg-green-700 transition-colors font-semibold shadow-lg">
                        💾 שמור שינויים ל-Firebase
                    </button>
                </div>
            </div>

            <!-- תוכן טאב משתמשים -->
            <div id="content-users" class="p-8 hidden">
                <h2 class="text-2xl font-bold text-slate-800 mb-4">👥 ניהול משתמשים</h2>
                <p class="text-slate-600 mb-6">
                    רשימת כל המשתמשים הרשומים במערכת
                </p>

                <div class="overflow-x-auto rounded-xl border border-slate-200 shadow-sm">
                    <table class="w-full table-auto bg-white">
                        <thead>
                            <tr class="bg-gradient-to-r from-slate-100 to-slate-50 border-b border-slate-200">
                                <th class="text-right p-4 font-bold text-slate-700">שם</th>
                                <th class="text-right p-4 font-bold text-slate-700">אימייל</th>
                                <th class="text-right p-4 font-bold text-slate-700">תאריך הרשמה</th>
                                <th class="text-right p-4 font-bold text-slate-700">פעילות אחרונה</th>
                                <th class="text-center p-4 font-bold text-slate-700">סטטוס</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr>
                                <td colspan="5" class="p-8 text-center text-slate-500">
                                    טוען נתונים...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- תוכן טאב ניתוחים -->
            <div id="content-analysis" class="p-8 hidden">
                <h2 class="text-2xl font-bold text-slate-800 mb-4">📊 ניתוחי משתמשים</h2>
                <p class="text-slate-600 mb-6">
                    סיכום ניתוחי ההוצאות של כל המשתמשים
                </p>

                <div class="overflow-x-auto rounded-xl border border-slate-200 shadow-sm">
                    <table class="w-full table-auto bg-white">
                        <thead>
                            <tr class="bg-gradient-to-r from-slate-100 to-slate-50 border-b border-slate-200">
                                <th class="text-right p-4 font-bold text-slate-700">משתמש</th>
                                <th class="text-right p-4 font-bold text-slate-700">מספר עסקאות</th>
                                <th class="text-right p-4 font-bold text-slate-700">סה"כ סכום</th>
                                <th class="text-right p-4 font-bold text-slate-700">עדכון אחרון</th>
                                <th class="text-center p-4 font-bold text-slate-700">פעולות</th>
                            </tr>
                        </thead>
                        <tbody id="analysisTableBody">
                            <tr>
                                <td colspan="5" class="p-8 text-center text-slate-500">
                                    טוען נתונים...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- הודעות מערכת -->
        <div id="notifications" class="fixed top-4 right-4 z-50"></div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, getDocs, doc, setDoc, deleteDoc, addDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCZZNWGH5c0sPsVPRFOvAA96Fdro0OjLi4",
            authDomain: "aba-tachon-course.firebaseapp.com",
            projectId: "aba-tachon-course",
            storageBucket: "aba-tachon-course.firebasestorage.app",
            messagingSenderId: "584836621111",
            appId: "1:584836621111:web:02275fe133c80e00cf70b2",
            measurementId: "G-X83LD4X4C0"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Make Firebase available globally
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.onAuthStateChanged = onAuthStateChanged;
        window.signOut = signOut;
        window.collection = collection;
        window.getDocs = getDocs;
        window.doc = doc;
        window.setDoc = setDoc;
        window.deleteDoc = deleteDoc;
        window.addDoc = addDoc;

        console.log('🔥 Firebase initialized in Admin Expenses Manager');
    </script>

    <script>
        // Global state
        let appState = {
            currentUser: null,
            activeTab: 'keywords',
            keywords: {},
            businesses: {},
            users: [],
            analyses: [],
            editingCell: null
        };

        // Authentication functions
        function checkAuthStatus() {
            return new Promise((resolve) => {
                // בדיקה ראשונית ב-localStorage
                const currentUser = localStorage.getItem('currentUser');
                if (currentUser) {
                    try {
                        const userData = JSON.parse(currentUser);
                        console.log('✅ נמצא משתמש ב-localStorage:', userData.email);
                        
                        // בדיקה אם זה מנהל
                        if (userData.email === 'yair.slv@gmail.com') {
                            appState.currentUser = {
                                uid: userData.id || 'local-admin',
                                email: userData.email,
                                displayName: userData.name,
                                photoURL: userData.photoURL || '/api/placeholder/40/40'
                            };
                            
                            updateAdminDisplay();
                            document.getElementById('authScreen').style.display = 'none';
                            document.getElementById('app').style.display = 'block';
                            resolve(true);
                            return;
                        } else {
                            alert('גישה מוגבלת למנהלים בלבד!');
                            resolve(false);
                            return;
                        }
                    } catch (error) {
                        console.error('❌ שגיאה בפרסור נתוני משתמש:', error);
                    }
                }

                // אם אין ב-localStorage, בדיקה ב-Firebase
                if (window.firebaseAuth) {
                    window.onAuthStateChanged(window.firebaseAuth, (user) => {
                        if (user && user.email === 'yair.slv@gmail.com') {
                            appState.currentUser = user;
                            updateAdminDisplay();
                            document.getElementById('authScreen').style.display = 'none';
                            document.getElementById('app').style.display = 'block';
                            resolve(true);
                        } else {
                            if (user) {
                                alert('גישה מוגבלת למנהלים בלבד!');
                            }
                            document.getElementById('authScreen').style.display = 'flex';
                            document.getElementById('app').style.display = 'none';
                            resolve(false);
                        }
                    });
                } else {
                    document.getElementById('authScreen').style.display = 'flex';
                    document.getElementById('app').style.display = 'none';
                    resolve(false);
                }
            });
        }

        function updateAdminDisplay() {
            if (appState.currentUser) {
                document.getElementById('adminEmail').textContent = appState.currentUser.email;
                document.getElementById('adminPhoto').src = appState.currentUser.photoURL || '/api/placeholder/40/40';
            }
        }

        function redirectToAuth() {
            window.location.href = 'index.html';
        }

        function signOut() {
            if (window.firebaseAuth) {
                window.signOut(window.firebaseAuth).then(() => {
                    localStorage.removeItem('currentUser');
                    document.getElementById('authScreen').style.display = 'flex';
                    document.getElementById('app').style.display = 'none';
                });
            } else {
                localStorage.removeItem('currentUser');
                document.getElementById('authScreen').style.display = 'flex';
                document.getElementById('app').style.display = 'none';
            }
        }

        // Tab management
        function switchTab(tabName) {
            // Update active tab
            appState.activeTab = tabName;
            
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            // Update content
            document.querySelectorAll('[id^="content-"]').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            
            // Load data for active tab
            loadTabData(tabName);
        }

        // Data loading functions
        async function loadTabData(tabName) {
            try {
                switch (tabName) {
                    case 'keywords':
                        await loadKeywords();
                        break;
                    case 'businesses':
                        await loadBusinesses();
                        break;
                    case 'users':
                        await loadUsers();
                        break;
                    case 'analysis':
                        await loadAnalyses();
                        break;
                }
            } catch (error) {
                console.error(`❌ שגיאה בטעינת נתוני ${tabName}:`, error);
                showNotification(`שגיאה בטעינת נתונים: ${error.message}`, 'error');
            }
        }

        async function loadKeywords() {
            try {
                const keywordsSnapshot = await window.getDocs(window.collection(window.firebaseDb, 'smartkeywords'));
                appState.keywords = {};
                
                keywordsSnapshot.forEach(doc => {
                    const data = doc.data();
                    const keyword = data['מילת מפתח'] || data.keyword;
                    const category = data['קטגוריה'] || data.category;
                    
                    if (keyword && category) {
                        appState.keywords[keyword] = {
                            category: category,
                            id: doc.id
                        };
                    }
                });
                
                renderKeywordsTable();
                updateStats();
                
            } catch (error) {
                console.error('❌ שגיאה בטעינת מילות מפתח:', error);
                document.getElementById('keywordsTableBody').innerHTML = `
                    <tr><td colspan="3" class="p-8 text-center text-red-500">שגיאה בטעינת נתונים: ${error.message}</td></tr>
                `;
            }
        }

        async function loadBusinesses() {
            try {
                const businessSnapshot = await window.getDocs(window.collection(window.firebaseDb, 'businessdatabase'));
                appState.businesses = {};
                
                businessSnapshot.forEach(doc => {
                    const data = doc.data();
                    const business = data['שם עסק'] || data.business;
                    const category = data['קטגוריה'] || data.category;
                    
                    if (business && category) {
                        appState.businesses[business] = {
                            category: category,
                            id: doc.id
                        };
                    }
                });
                
                renderBusinessesTable();
                updateStats();
                
            } catch (error) {
                console.error('❌ שגיאה בטעינת עסקים:', error);
                document.getElementById('businessesTableBody').innerHTML = `
                    <tr><td colspan="3" class="p-8 text-center text-red-500">שגיאה בטעינת נתונים: ${error.message}</td></tr>
                `;
            }
        }

        async function loadUsers() {
            try {
                const usersSnapshot = await window.getDocs(window.collection(window.firebaseDb, 'users'));
                appState.users = [];
                
                usersSnapshot.forEach(doc => {
                    const data = doc.data();
                    appState.users.push({
                        id: doc.id,
                        ...data
                    });
                });
                
                renderUsersTable();
                updateStats();
                
            } catch (error) {
                console.error('❌ שגיאה בטעינת משתמשים:', error);
                document.getElementById('usersTableBody').innerHTML = `
                    <tr><td colspan="5" class="p-8 text-center text-red-500">שגיאה בטעינת נתונים: ${error.message}</td></tr>
                `;
            }
        }

        async function loadAnalyses() {
            try {
                const analysisSnapshot = await window.getDocs(window.collection(window.firebaseDb, 'userAnalysis'));
                appState.analyses = [];
                
                analysisSnapshot.forEach(doc => {
                    const data = doc.data();
                    appState.analyses.push({
                        id: doc.id,
                        ...data
                    });
                });
                
                renderAnalysesTable();
                updateStats();
                
            } catch (error) {
                console.error('❌ שגיאה בטעינת ניתוחים:', error);
                document.getElementById('analysisTableBody').innerHTML = `
                    <tr><td colspan="5" class="p-8 text-center text-red-500">שגיאה בטעינת נתונים: ${error.message}</td></tr>
                `;
            }
        }

        // Render functions
        function renderKeywordsTable() {
            const tbody = document.getElementById('keywordsTableBody');
            const keywords = Object.entries(appState.keywords);
            
            if (keywords.length === 0) {
                tbody.innerHTML = `
                    <tr><td colspan="3" class="p-8 text-center text-slate-500">אין מילות מפתח במאגר</td></tr>
                `;
                return;
            }
            
            tbody.innerHTML = keywords.map(([keyword, data]) => `
                <tr class="table-row border-b border-slate-100">
                    <td class="p-4 editable-cell" onclick="editCell(this, 'keyword', '${keyword}')">${keyword}</td>
                    <td class="p-4 editable-cell" onclick="editCell(this, 'category', '${keyword}')">${data.category}</td>
                    <td class="p-4 text-center">
                        <button onclick="deleteKeyword('${keyword}')" 
                                class="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700 transition-colors">
                            מחק
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function renderBusinessesTable() {
            const tbody = document.getElementById('businessesTableBody');
            const businesses = Object.entries(appState.businesses);
            
            if (businesses.length === 0) {
                tbody.innerHTML = `
                    <tr><td colspan="3" class="p-8 text-center text-slate-500">אין עסקים במאגר</td></tr>
                `;
                return;
            }
            
            tbody.innerHTML = businesses.map(([business, data]) => `
                <tr class="table-row border-b border-slate-100">
                    <td class="p-4 editable-cell" onclick="editCell(this, 'business', '${business}')">${business}</td>
                    <td class="p-4 editable-cell" onclick="editCell(this, 'category', '${business}')">${data.category}</td>
                    <td class="p-4 text-center">
                        <button onclick="deleteBusiness('${business}')" 
                                class="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700 transition-colors">
                            מחק
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function renderUsersTable() {
            const tbody = document.getElementById('usersTableBody');
            
            if (appState.users.length === 0) {
                tbody.innerHTML = `
                    <tr><td colspan="5" class="p-8 text-center text-slate-500">אין משתמשים במערכת</td></tr>
                `;
                return;
            }
            
            tbody.innerHTML = appState.users.map(user => `
                <tr class="table-row border-b border-slate-100">
                    <td class="p-4">${user.name || 'לא צוין'}</td>
                    <td class="p-4">${user.email}</td>
                    <td class="p-4">${formatDate(user.registeredAt)}</td>
                    <td class="p-4">${formatDate(user.lastActivity)}</td>
                    <td class="p-4 text-center">
                        <span class="inline-block px-3 py-1 rounded-full text-sm ${user.approved ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                            ${user.approved ? '✅ מאושר' : '⏳ ממתין'}
                        </span>
                    </td>
                </tr>
            `).join('');
        }

        function renderAnalysesTable() {
            const tbody = document.getElementById('analysisTableBody');
            
            if (appState.analyses.length === 0) {
                tbody.innerHTML = `
                    <tr><td colspan="5" class="p-8 text-center text-slate-500">אין ניתוחים במערכת</td></tr>
                `;
                return;
            }
            
            tbody.innerHTML = appState.analyses.map(analysis => {
                const totalAmount = analysis.transactions ? 
                    analysis.transactions.reduce((sum, t) => sum + (t.amount || 0), 0) : 0;
                
                return `
                    <tr class="table-row border-b border-slate-100">
                        <td class="p-4">${analysis.userEmail}</td>
                        <td class="p-4">${analysis.transactions ? analysis.transactions.length : 0}</td>
                        <td class="p-4">₪${totalAmount.toLocaleString()}</td>
                        <td class="p-4">${formatDate(analysis.lastUpdated)}</td>
                        <td class="p-4 text-center">
                            <button onclick="viewAnalysis('${analysis.id}')" 
                                    class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700 transition-colors">
                                צפייה
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // CSV upload handlers
        async function handleKeywordsUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            try {
                const csvData = await parseCSV(file);
                console.log('📊 נתוני CSV שנטענו:', csvData);
                
                let successCount = 0;
                
                for (const row of csvData) {
                    const keyword = row['מילת מפתח'] || row['keyword'] || row['מילה'] || Object.values(row)[0];
                    const category = row['קטגוריה'] || row['category'] || row['סיווג'] || Object.values(row)[1];
                    
                    if (keyword && category && keyword.trim() && category.trim()) {
                        appState.keywords[keyword.trim()] = {
                            category: category.trim(),
                            id: null // יקבל ID חדש בשמירה
                        };
                        successCount++;
                    }
                }
                
                renderKeywordsTable();
                updateStats();
                showNotification(`✅ נטענו ${successCount} מילות מפתח מהקובץ!`, 'success');
                
            } catch (error) {
                console.error('❌ שגיאה בטעינת קובץ:', error);
                showNotification(`❌ שגיאה בטעינת קובץ: ${error.message}`, 'error');
            }
        }

        async function handleBusinessesUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            try {
                const csvData = await parseCSV(file);
                console.log('📊 נתוני CSV עסקים שנטענו:', csvData);
                
                let successCount = 0;
                
                for (const row of csvData) {
                    const business = row['שם עסק'] || row['business'] || row['עסק'] || Object.values(row)[0];
                    const category = row['קטגוריה'] || row['category'] || row['סיווג'] || Object.values(row)[1];
                    
                    if (business && category && business.trim() && category.trim()) {
                        appState.businesses[business.trim()] = {
                            category: category.trim(),
                            id: null // יקבל ID חדש בשמירה
                        };
                        successCount++;
                    }
                }
                
                renderBusinessesTable();
                updateStats();
                showNotification(`✅ נטענו ${successCount} עסקים מהקובץ!`, 'success');
                
            } catch (error) {
                console.error('❌ שגיאה בטעינת קובץ עסקים:', error);
                showNotification(`❌ שגיאה בטעינת קובץ: ${error.message}`, 'error');
            }
        }

        // Helper function to parse CSV
        function parseCSV(file) {
            return new Promise((resolve, reject) => {
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    encoding: 'UTF-8',
                    complete: (results) => {
                        if (results.errors.length > 0) {
                            reject(new Error('שגיאות בקובץ CSV: ' + results.errors.map(e => e.message).join(', ')));
                        } else {
                            resolve(results.data);
                        }
                    },
                    error: (error) => {
                        reject(error);
                    }
                });
            });
        }

        // Add/Edit/Delete functions
        function addKeyword() {
            const keyword = document.getElementById('newKeyword').value.trim();
            const category = document.getElementById('newKeywordCategory').value;
            
            if (!keyword || !category) {
                showNotification('❌ יש למלא את כל השדות', 'error');
                return;
            }
            
            if (appState.keywords[keyword]) {
                showNotification('❌ מילת המפתח כבר קיימת', 'error');
                return;
            }
            
            appState.keywords[keyword] = {
                category: category,
                id: null
            };
            
            renderKeywordsTable();
            updateStats();
            
            // Clear inputs
            document.getElementById('newKeyword').value = '';
            document.getElementById('newKeywordCategory').value = '';
            
            showNotification('✅ מילת מפתח נוספה בהצלחה!', 'success');
        }

        function addBusiness() {
            const business = document.getElementById('newBusiness').value.trim();
            const category = document.getElementById('newBusinessCategory').value;
            
            if (!business || !category) {
                showNotification('❌ יש למלא את כל השדות', 'error');
                return;
            }
            
            if (appState.businesses[business]) {
                showNotification('❌ העסק כבר קיים במאגר', 'error');
                return;
            }
            
            appState.businesses[business] = {
                category: category,
                id: null
            };
            
            renderBusinessesTable();
            updateStats();
            
            // Clear inputs
            document.getElementById('newBusiness').value = '';
            document.getElementById('newBusinessCategory').value = '';
            
            showNotification('✅ עסק נוסף בהצלחה!', 'success');
        }

        function deleteKeyword(keyword) {
            if (confirm(`האם אתה בטוח שברצונך למחוק את המילה "${keyword}"?`)) {
                delete appState.keywords[keyword];
                renderKeywordsTable();
                updateStats();
                showNotification('✅ מילת מפתח נמחקה', 'success');
            }
        }

        function deleteBusiness(business) {
            if (confirm(`האם אתה בטוח שברצונך למחוק את העסק "${business}"?`)) {
                delete appState.businesses[business];
                renderBusinessesTable();
                updateStats();
                showNotification('✅ עסק נמחק', 'success');
            }
        }

        // Edit cell functionality
        function editCell(cell, type, key) {
            if (appState.editingCell) {
                return; // כבר עורך תא אחר
            }
            
            appState.editingCell = cell;
            const originalValue = cell.textContent;
            
            if (type === 'category') {
                // Create select for category
                const select = document.createElement('select');
                select.className = 'w-full border border-blue-500 rounded px-2 py-1 focus:outline-none';
                
                const categories = ['מזון', 'רכב', 'בריאות', 'ביטוח', 'חשבונות', 'חינוך', 'דיור', 'החזר חוב', 'קניות לבית', 'השקעות', 'פנאי', 'אחר'];
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    option.selected = cat === originalValue;
                    select.appendChild(option);
                });
                
                cell.innerHTML = '';
                cell.appendChild(select);
                select.focus();
                
                const saveEdit = () => {
                    const newValue = select.value;
                    cell.textContent = newValue;
                    
                    // Update data
                    if (appState.activeTab === 'keywords') {
                        appState.keywords[key].category = newValue;
                    } else if (appState.activeTab === 'businesses') {
                        appState.businesses[key].category = newValue;
                    }
                    
                    appState.editingCell = null;
                    cell.classList.remove('editing');
                    showNotification('✅ שינוי נשמר', 'success');
                };
                
                select.addEventListener('blur', saveEdit);
                select.addEventListener('change', saveEdit);
                
            } else {
                // Create input for text
                const input = document.createElement('input');
                input.type = 'text';
                input.value = originalValue;
                input.className = 'w-full border border-blue-500 rounded px-2 py-1 focus:outline-none';
                
                cell.innerHTML = '';
                cell.appendChild(input);
                input.focus();
                input.select();
                
                const saveEdit = () => {
                    const newValue = input.value.trim();
                    if (!newValue) {
                        cell.textContent = originalValue;
                        appState.editingCell = null;
                        cell.classList.remove('editing');
                        return;
                    }
                    
                    cell.textContent = newValue;
                    
                    // Update data - need to handle key change
                    if (appState.activeTab === 'keywords') {
                        if (newValue !== key) {
                            appState.keywords[newValue] = appState.keywords[key];
                            delete appState.keywords[key];
                            renderKeywordsTable(); // Re-render to update event handlers
                        }
                    } else if (appState.activeTab === 'businesses') {
                        if (newValue !== key) {
                            appState.businesses[newValue] = appState.businesses[key];
                            delete appState.businesses[key];
                            renderBusinessesTable(); // Re-render to update event handlers
                        }
                    }
                    
                    appState.editingCell = null;
                    cell.classList.remove('editing');
                    showNotification('✅ שינוי נשמר', 'success');
                };
                
                input.addEventListener('blur', saveEdit);
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        saveEdit();
                    }
                });
            }
            
            cell.classList.add('editing');
        }

        // Save to Firebase functions
        async function saveKeywordsToFirebase() {
            try {
                showNotification('💾 שומר מילות מפתח ל-Firebase...', 'info');
                
                // Clear existing collection
                const existingDocs = await window.getDocs(window.collection(window.firebaseDb, 'smartkeywords'));
                const deletePromises = existingDocs.docs.map(doc => 
                    window.deleteDoc(window.doc(window.firebaseDb, 'smartkeywords', doc.id))
                );
                await Promise.all(deletePromises);
                
                // Add new data
                const addPromises = Object.entries(appState.keywords).map(([keyword, data]) => 
                    window.addDoc(window.collection(window.firebaseDb, 'smartkeywords'), {
                        'מילת מפתח': keyword,
                        'קטגוריה': data.category
                    })
                );
                
                await Promise.all(addPromises);
                
                showNotification('✅ מילות מפתח נשמרו ל-Firebase בהצלחה!', 'success');
                
            } catch (error) {
                console.error('❌ שגיאה בשמירה ל-Firebase:', error);
                showNotification('❌ שגיאה בשמירה: ' + error.message, 'error');
            }
        }

        async function saveBusinessesToFirebase() {
            try {
                showNotification('💾 שומר עסקים ל-Firebase...', 'info');
                
                // Clear existing collection
                const existingDocs = await window.getDocs(window.collection(window.firebaseDb, 'businessdatabase'));
                const deletePromises = existingDocs.docs.map(doc => 
                    window.deleteDoc(window.doc(window.firebaseDb, 'businessdatabase', doc.id))
                );
                await Promise.all(deletePromises);
                
                // Add new data
                const addPromises = Object.entries(appState.businesses).map(([business, data]) => 
                    window.addDoc(window.collection(window.firebaseDb, 'businessdatabase'), {
                        'שם עסק': business,
                        'קטגוריה': data.category
                    })
                );
                
                await Promise.all(addPromises);
                
                showNotification('✅ עסקים נשמרו ל-Firebase בהצלחה!', 'success');
                
            } catch (error) {
                console.error('❌ שגיאה בשמירה ל-Firebase:', error);
                showNotification('❌ שגיאה בשמירה: ' + error.message, 'error');
            }
        }

        // Utility functions
        function updateStats() {
            document.getElementById('keywordsCount').textContent = Object.keys(appState.keywords).length;
            document.getElementById('businessesCount').textContent = Object.keys(appState.businesses).length;
            document.getElementById('usersCount').textContent = appState.users.length;
            document.getElementById('analysisCount').textContent = appState.analyses.length;
        }

        function formatDate(dateString) {
            if (!dateString) return 'לא זמין';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('he-IL') + ' ' + date.toLocaleTimeString('he-IL', {hour: '2-digit', minute: '2-digit'});
            } catch {
                return 'תאריך לא תקין';
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500',
                warning: 'bg-yellow-500'
            };
            
            notification.className = `${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg mb-4 transition-all duration-300`;
            notification.textContent = message;
            
            document.getElementById('notifications').appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 5000);
        }

        function viewAnalysis(analysisId) {
            const analysis = appState.analyses.find(a => a.id === analysisId);
            if (analysis) {
                alert(`ניתוח של ${analysis.userEmail}:\n${analysis.transactions ? analysis.transactions.length : 0} עסקאות\nעדכון אחרון: ${formatDate(analysis.lastUpdated)}`);
            }
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🚀 Admin Expenses Manager נטען...');
            
            const isAuthenticated = await checkAuthStatus();
            
            if (isAuthenticated) {
                // Load initial data
                await loadTabData('keywords');
                updateStats();
            }
        });
    </script>
</body>
</html>